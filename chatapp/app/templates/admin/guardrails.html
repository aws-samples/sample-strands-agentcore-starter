{% extends "base.html" %}

{% block title %}Guardrails Analytics - Admin{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    {% set breadcrumbs = [
        {'label': 'Admin', 'url': '/admin'},
        {'label': 'Guardrails'}
    ] %}
    {% include "components/admin_header.html" %}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Time Range Selector -->
        <div class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex flex-wrap items-center gap-4">
                <span class="text-sm font-medium text-gray-700">Time Range:</span>
                <div class="flex gap-2" id="preset-buttons">
                    <button onclick="setTimeRange(1)" id="btn-1" class="px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">Today</button>
                    <button onclick="setTimeRange(7)" id="btn-7" class="px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">7 Days</button>
                    <button onclick="setTimeRange(30)" id="btn-30" class="px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">30 Days</button>
                </div>
                <div class="flex items-center gap-2 ml-auto">
                    <label class="text-xs text-gray-500">From:</label>
                    <input type="date" id="start-date" class="px-2 py-1 text-sm border border-gray-300 rounded-md" value="{{ start_time[:10] }}">
                    <label class="text-xs text-gray-500">To:</label>
                    <input type="date" id="end-date" class="px-2 py-1 text-sm border border-gray-300 rounded-md" value="{{ end_time[:10] }}">
                    <button onclick="applyCustomRange()" class="px-3 py-1.5 text-sm rounded-md bg-primary-600 hover:bg-primary-700 text-white transition-colors">Apply</button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Violations -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Violations</p>
                        <p class="text-2xl font-bold text-amber-600 mt-1">{{ "{:,}".format(stats.violation_count) }}</p>
                    </div>
                    <div class="p-3 bg-amber-100 rounded-full">
                        <svg class="w-6 h-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                </div>
                <div class="mt-3 flex gap-4 text-xs text-gray-500">
                    <span>Input: {{ stats.input_violations }}</span>
                    <span>Output: {{ stats.output_violations }}</span>
                </div>
            </div>

            <!-- Unique Users -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Users</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.unique_users }}</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
                <p class="mt-3 text-xs text-gray-500">{{ days_in_period }} day{{ 's' if days_in_period != 1 else '' }} period</p>
            </div>

            <!-- Unique Sessions -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Sessions</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">{{ stats.unique_sessions }}</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-full">
                        <svg class="w-6 h-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                </div>
                <p class="mt-3 text-xs text-gray-500">Sessions with violations</p>
            </div>

            <!-- Top Violation Type -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Top Violation</p>
                        {% if stats.top_filter %}
                        <p class="text-xl font-bold text-red-600 mt-1">{{ stats.top_filter }}</p>
                        {% else %}
                        <p class="text-xl font-bold text-gray-400 mt-1">—</p>
                        {% endif %}
                    </div>
                    <div class="p-3 bg-red-100 rounded-full">
                        <svg class="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                </div>
                {% if stats.top_filter %}
                <p class="mt-3 text-xs text-gray-500">{{ stats.top_filter_count }} occurrence{{ 's' if stats.top_filter_count != 1 else '' }}</p>
                {% else %}
                <p class="mt-3 text-xs text-gray-500">No violations</p>
                {% endif %}
            </div>
        </div>

        <!-- Policy Breakdown Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Violations by Filter Type</h2>
                <p class="text-sm text-gray-500 mt-1">Breakdown of violations by specific guardrail filter</p>
            </div>
            
            {% if stats.filter_breakdown %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filter Type</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Violations</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for filter_key, count in stats.filter_breakdown.items() %}
                        {% set parts = filter_key.split(':') %}
                        {% set policy_type = parts[0] if parts|length > 1 else 'content' %}
                        {% set filter_type = parts[1] if parts|length > 1 else filter_key %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    {% if policy_type == 'content' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                                    {% elif policy_type == 'topic' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-orange-500"></span>
                                    {% elif policy_type == 'word' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-500"></span>
                                    {% elif policy_type == 'sensitive_information' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-purple-500"></span>
                                    {% else %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-gray-500"></span>
                                    {% endif %}
                                    <span class="text-sm font-medium text-gray-900 capitalize">{{ policy_type.replace('_', ' ') }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                                    {% if policy_type == 'content' %}bg-red-100 text-red-800
                                    {% elif policy_type == 'topic' %}bg-orange-100 text-orange-800
                                    {% elif policy_type == 'word' %}bg-yellow-100 text-yellow-800
                                    {% elif policy_type == 'sensitive_information' %}bg-purple-100 text-purple-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ filter_type }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">{{ "{:,}".format(count) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500">
                                {% if stats.violation_count > 0 %}
                                {{ "%.1f"|format(count / stats.violation_count * 100) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% elif stats.policy_breakdown %}
            <!-- Fallback to policy breakdown if filter breakdown not available -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy Type</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Violations</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for policy_type, count in stats.policy_breakdown.items() %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    {% if policy_type == 'content' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-red-500"></span>
                                    {% elif policy_type == 'topic' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-orange-500"></span>
                                    {% elif policy_type == 'word' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-500"></span>
                                    {% elif policy_type == 'sensitive_information' %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-purple-500"></span>
                                    {% else %}
                                    <span class="inline-block w-2 h-2 rounded-full bg-gray-500"></span>
                                    {% endif %}
                                    <span class="text-sm font-medium text-gray-900 capitalize">{{ policy_type.replace('_', ' ') }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">{{ "{:,}".format(count) }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500">
                                {% if stats.violation_count > 0 %}
                                {{ "%.1f"|format(count / stats.violation_count * 100) }}%
                                {% else %}
                                0%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="px-6 py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No violations</h3>
                <p class="mt-1 text-sm text-gray-500">No guardrail violations detected in the selected time period.</p>
            </div>
            {% endif %}
        </div>

        <!-- Recent Violations Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Recent Violations</h2>
                <p class="text-sm text-gray-500 mt-1">Latest guardrail violations with details</p>
            </div>
            
            {% if violations %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-10 px-3 py-3"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Violations</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strength</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for violation in violations %}
                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleDetails('details-{{ loop.index }}', this)">
                            <td class="w-10 px-3 py-4 text-center">
                                <button class="expand-btn text-gray-400 hover:text-gray-600 transition-transform duration-200">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" data-utc-timestamp="{{ violation.timestamp }}" data-include-seconds="true">
                                {{ violation.timestamp[:19].replace('T', ' ') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <a href="/admin/users/{{ violation.user_id }}" class="text-sm font-medium text-primary-600 hover:text-primary-800 hover:underline" onclick="event.stopPropagation()">
                                    {{ user_emails.get(violation.user_id) or violation.user_id }}
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ violation.source | capitalize }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ violation.get_filter_types() | map(attribute='type') | join(', ') }}
                            </td>
                            {% set details = violation.get_filter_details() %}
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if details.strength == 'HIGH' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">HIGH</span>
                                {% elif details.strength == 'MEDIUM' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">MEDIUM</span>
                                {% elif details.strength == 'LOW' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">LOW</span>
                                {% else %}
                                <span class="text-sm text-gray-400">—</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if details.confidence == 'HIGH' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">HIGH</span>
                                {% elif details.confidence == 'MEDIUM' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">MEDIUM</span>
                                {% elif details.confidence == 'LOW' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">LOW</span>
                                {% else %}
                                <span class="text-sm text-gray-400">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        <!-- Expandable Details Row -->
                        <tr id="details-{{ loop.index }}" class="hidden bg-gray-50">
                            <td colspan="7" class="px-6 py-4">
                                <div class="space-y-3 ml-10">
                                    {% if violation.content_preview %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-500 uppercase">Content Preview:</span>
                                        <p class="mt-1 text-sm text-gray-700 bg-white p-2 rounded border border-gray-200">{{ violation.content_preview }}</p>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <span class="text-xs font-medium text-gray-500 uppercase">Assessment Details:</span>
                                        <div class="mt-1 bg-white p-3 rounded border border-gray-200 overflow-x-auto">
                                            <pre class="text-xs text-gray-700 whitespace-pre-wrap">{{ violation.assessments | tojson(indent=2) }}</pre>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 text-xs text-gray-500">
                                        <span>User ID: <a href="/admin/users/{{ violation.user_id }}" class="text-primary-600 hover:text-primary-800 hover:underline">{{ violation.user_id }}</a></span>
                                        <span>Session ID: <a href="/admin/sessions/{{ violation.session_id }}" class="text-primary-600 hover:text-primary-800 hover:underline">{{ violation.session_id }}</a></span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="px-6 py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No violations</h3>
                <p class="mt-1 text-sm text-gray-500">No guardrail violations detected in the selected time period.</p>
            </div>
            {% endif %}
        </div>

    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/admin-utils.js') }}"></script>
<script>
    function toggleDetails(id, clickedRow) {
        const row = document.getElementById(id);
        if (row) {
            row.classList.toggle('hidden');
            const expandBtn = clickedRow.querySelector('.expand-btn');
            if (expandBtn) {
                if (row.classList.contains('hidden')) {
                    expandBtn.classList.remove('rotate-90');
                } else {
                    expandBtn.classList.add('rotate-90');
                }
            }
        }
    }
</script>
{% endblock %}
